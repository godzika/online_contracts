<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sign Contract</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .signature-pad-container {
            border: 2px dashed #0d6efd;
            border-radius: .375rem;
            background-color: #fff;
            width: 100%;
            height: 250px;
            position: relative;
        }
        canvas {
            cursor: crosshair;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<div class="container my-4 my-md-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">

            <div id="message-area" class="text-center" style="display: none;">
                <div class="card shadow-lg border-0">
                    <div class="card-body p-4 p-md-5">
                        <i id="message-icon" class="bi" style="font-size: 4rem;"></i>
                        <h2 id="message-title" class="mt-3"></h2>
                        <p id="message-text" class="lead"></p>
                        <button class="btn btn-primary" onclick="window.close()">Close Window</button>
                    </div>
                </div>
            </div>

            <div class="card shadow-lg border-0" id="signing-card">
                <div class="card-header bg-dark text-white p-4">
                    <h3 class="mb-0" id="contract-title">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Loading contract...
                    </h3>
                </div>
                <div class="card-body p-4 p-md-5">
                    <p class="lead">Please review the document below and provide your signature.</p>
                    <p><strong>Signee:</strong> <span id="signee-name" class="text-primary fw-bold">...</span></p>
                    <hr>

                    <div id="contract-content" class="border p-3 mb-4 rounded" style="max-height: 300px; overflow-y: auto; background-color: #fdfdfd;">
                        <div class="text-center p-3">
                            <span class="spinner-border" role="status" aria-hidden="true"></span>
                        </div>
                    </div>

                    <p class="fw-bold">Please sign in the box below:</p>
                    <div class="signature-pad-container mb-2">
                        <canvas id="signature-pad"></canvas>
                    </div>
                    <div class="text-end">
                        <button class="btn btn-sm btn-outline-secondary" id="clear-button">
                            <i class="bi bi-eraser-fill me-1"></i>Clear
                        </button>
                    </div>
                </div>
                <div class="card-footer p-4 bg-light text-end">
                    <button class="btn btn-success btn-lg" id="sign-button">
                        <i class="bi bi-check-lg me-2"></i>Sign and Submit
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
    $(document).ready(function() {
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)'
        });

        function resizeCanvas() {
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        resizeCanvas();
        $(window).resize(resizeCanvas);

        const urlParams = new URLSearchParams(window.location.search);
        const contractToken = urlParams.get('token');

        if (!contractToken) {
            showError('Invalid Link', 'This signature link is invalid or missing a token.');
            return;
        }

        $.ajax({
            url: `/api/public/contract/${contractToken}`,
            type: 'GET'
        })
            .done(function(contract) {
                $('#contract-title').html(`<i class="bi bi-file-text-fill me-2"></i>${contract.title}`);
                $('#signee-name').text(contract.signeeName);
                $('#contract-content').html(contract.content);
            })
            .fail(function() {
                showError('Link Expired', 'This signature link is invalid, has expired, or the contract is already signed.');
            });

        $('#sign-button').on('click', function() {
            if (signaturePad.isEmpty()) {
                return alert('Please provide your signature.');
            }

            const signatureData = signaturePad.toDataURL('image/png');
            const $btn = $(this);
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Submitting...');

            $.ajax({
                url: `/api/public/contract/${contractToken}/sign`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    signatureData: signatureData
                })
            })
                .done(function(response) {
                    showSuccess('Thank You!', 'The contract has been successfully signed.');
                })
                .fail(function(err) {
                    const errorMsg = err.responseJSON?.message || 'An error occurred while submitting.';
                    showError('Submission Failed', errorMsg);
                    $btn.prop('disabled', false).html('<i class="bi bi-check-lg me-2"></i>Sign and Submit');
                });
        });

        $('#clear-button').on('click', function() {
            signaturePad.clear();
        });

        function showMessage(type, icon, title, text) {
            $('#signing-card').hide();
            $('#message-icon').removeClass('bi-check-circle-fill bi-x-circle-fill text-success text-danger').addClass(icon).addClass(type === 'success' ? 'text-success' : 'text-danger');
            $('#message-title').text(title);
            $('#message-text').text(text);
            $('#message-area').show();
        }

        function showError(title, message) {
            showMessage('danger', 'bi-x-circle-fill', title, message);
        }

        function showSuccess(title, message) {
            showMessage('success', 'bi-check-circle-fill', title, message);
        }
    });
</script>
</body>
</html>
